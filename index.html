<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#7BA591">
  <title>Deutsch √ºben</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    /* Nat√ºrliches Farbschema */
    :root {
      --color-primary: #7BA591;        /* Salbeigr√ºn - beruhigend */
      --color-primary-dark: #5D8A75;
      --color-primary-light: #A8C9B8;
      --color-accent: #E8B86D;          /* Warmes Gold */
      --color-accent-dark: #D4A055;
      --color-success: #88B894;
      --color-error: #D4816F;
      --color-text: #3D4F42;
      --color-text-light: #6B7C70;
      --color-bg: #F9F7F4;              /* Warmes Wei√ü */
      --color-surface: #FFFFFF;
      --color-border: #E3DED7;
      --shadow-sm: 0 2px 8px rgba(61, 79, 66, 0.08);
      --shadow-md: 0 4px 16px rgba(61, 79, 66, 0.12);
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      --font-display: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'Segoe UI', 'Roboto', sans-serif;
      --font-body: -apple-system, BlinkMacSystemFont, 'SF Pro Text', 'Segoe UI', 'Roboto', sans-serif;
    }
    
    html {
      height: 100%;
      overflow: hidden;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    
    body { 
      font-family: var(--font-body);
      background: var(--color-bg);
      height: 100vh;
      height: 100dvh;
      overflow: hidden;
      padding: 0;
      color: var(--color-text);
      position: fixed;
      width: 100%;
      -webkit-overflow-scrolling: touch;
      font-weight: 400;
      letter-spacing: 0.01em;
      line-height: 1.6;
    }
    
    .app-wrapper {
      height: 100vh;
      height: 100dvh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    
    .container { 
      max-width: 900px; 
      margin: 0 auto;
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 16px;
      padding-bottom: calc(16px + env(safe-area-inset-bottom));
      -webkit-overflow-scrolling: touch;
    }
    
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      background: var(--color-surface);
      padding: 16px;
      padding-top: calc(16px + env(safe-area-inset-top));
      box-shadow: var(--shadow-sm);
      position: sticky;
      top: 0;
      z-index: 100;
      flex-shrink: 0;
      border-bottom: 1px solid var(--color-border);
    }
    
    .logo { 
      font-size: 1.35rem; 
      font-weight: 600;
      color: var(--color-primary-dark);
      white-space: nowrap;
      letter-spacing: -0.02em;
      font-family: var(--font-display);
    }
    
    .stats {
      display: flex;
      gap: 8px;
      flex-wrap: nowrap;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      -ms-overflow-style: none;
    }
    
    .stats::-webkit-scrollbar {
      display: none;
    }
    
    .stat-box {
      background: var(--color-primary-light);
      padding: 6px 12px;
      border-radius: var(--radius-sm);
      font-weight: 600;
      font-size: 0.85rem;
      color: var(--color-primary-dark);
      border: 1px solid var(--color-primary);
      white-space: nowrap;
      flex-shrink: 0;
    }
    
    .stat-value { 
      font-weight: 600; 
      margin-left: 4px; 
      color: var(--color-primary-dark);
      font-feature-settings: 'tnum';
      font-variant-numeric: tabular-nums;
    }

    /* Badges */
    .badges-section {
      background: linear-gradient(135deg, var(--color-accent) 0%, var(--color-accent-dark) 100%);
      border-radius: var(--radius-md);
      padding: 16px;
      margin-bottom: 16px;
      display: flex;
      gap: 12px;
      overflow-x: auto;
      align-items: center;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }

    .badges-section::-webkit-scrollbar {
      display: none;
    }

    .badge {
      min-width: 70px;
      text-align: center;
      padding: 12px;
      background: var(--color-surface);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-sm);
      transition: var(--transition);
      cursor: pointer;
      flex-shrink: 0;
    }

    .badge:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .badge.unlocked {
      animation: badgeUnlock 0.6s ease;
    }

    @keyframes badgeUnlock {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    .badge.locked {
      opacity: 0.3;
      filter: grayscale(100%);
    }

    .badge-icon {
      font-size: 2rem;
      display: block;
      margin-bottom: 4px;
    }

    .badge-name {
      font-size: 0.7rem;
      font-weight: 600;
      color: var(--color-text);
    }

    /* Rank Section */
    .rank-section {
      background: linear-gradient(135deg, var(--color-primary-light) 0%, var(--color-primary) 100%);
      border-radius: var(--radius-md);
      padding: 16px;
      margin-bottom: 16px;
      display: flex;
      justify-content: space-around;
      align-items: center;
      border: 1px solid var(--color-primary);
    }

    .rank-item {
      text-align: center;
    }

    .rank-icon {
      font-size: 2rem;
      display: block;
      margin-bottom: 4px;
    }

    .rank-label {
      font-size: 0.75rem;
      color: var(--color-primary-dark);
      font-weight: 600;
    }

    .rank-value {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--color-surface);
      font-feature-settings: 'tnum';
      font-variant-numeric: tabular-nums;
    }

    /* Challenge Mode */
    .challenge-mode {
      background: linear-gradient(135deg, var(--color-error) 0%, #C87160 100%);
      border-radius: var(--radius-md);
      padding: 16px;
      margin-bottom: 16px;
      text-align: center;
      cursor: pointer;
      transition: var(--transition);
      border: 2px solid transparent;
    }

    .challenge-mode:hover {
      border-color: var(--color-error);
      transform: scale(1.02);
      box-shadow: var(--shadow-md);
    }

    .challenge-mode.active {
      border-color: var(--color-error);
      animation: pulse 1s ease infinite;
    }

    @keyframes pulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(212, 129, 111, 0.7); }
      50% { box-shadow: 0 0 0 10px rgba(212, 129, 111, 0); }
    }

    .timer {
      font-size: 2rem;
      font-weight: 700;
      color: var(--color-surface);
      margin: 8px 0;
      font-feature-settings: 'tnum';
      font-variant-numeric: tabular-nums;
    }

    .challenge-title {
      font-weight: 700;
      font-size: 1.1rem;
      color: var(--color-surface);
      margin-bottom: 4px;
    }

    .challenge-desc {
      font-size: 0.85rem;
      color: rgba(255, 255, 255, 0.9);
    }

    .card { 
      background: var(--color-surface);
      border-radius: var(--radius-lg); 
      padding: 24px;
      box-shadow: var(--shadow-sm);
      border: 1px solid var(--color-border);
      margin-bottom: 16px;
    }

    .section-title {
      font-size: 0.875rem;
      font-weight: 700;
      color: var(--color-text-light);
      margin-bottom: 12px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .grade-buttons {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 16px;
    }

    .grade-btn {
      padding: 16px;
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      background: var(--color-surface);
      cursor: pointer;
      font-weight: 600;
      font-size: 0.95rem;
      color: var(--color-text);
      transition: var(--transition);
      text-align: center;
    }

    .grade-btn:hover {
      background: var(--color-bg);
      border-color: var(--color-primary);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .grade-btn.active {
      background: var(--color-primary);
      border-color: var(--color-primary-dark);
      color: var(--color-surface);
    }

    .grade-emoji {
      display: block;
      font-size: 2rem;
      margin-bottom: 6px;
    }

    .difficulty-selector {
      display: flex;
      gap: 8px;
      margin-bottom: 16px;
      flex-wrap: wrap;
    }

    .difficulty-btn {
      flex: 1;
      min-width: 100px;
      padding: 10px 16px;
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      background: var(--color-surface);
      color: var(--color-text);
      font-size: 0.85rem;
      font-weight: 600;
      cursor: pointer;
      transition: var(--transition);
    }

    .difficulty-btn:hover {
      background: var(--color-bg);
      border-color: var(--color-primary);
    }

    .difficulty-btn.active {
      background: var(--color-primary);
      border-color: var(--color-primary-dark);
      color: var(--color-surface);
    }

    .progress-section {
      background: var(--color-bg);
      border-radius: var(--radius-md);
      padding: 16px;
      margin-bottom: 16px;
      border: 1px solid var(--color-border);
    }

    .progress-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
      font-size: 0.85rem;
      color: var(--color-text-light);
      font-weight: 600;
    }

    .progress-bar {
      height: 8px;
      background: var(--color-border);
      border-radius: var(--radius-sm);
      overflow: hidden;
      position: relative;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
      border-radius: var(--radius-sm);
      transition: width 0.6s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .question-card {
      background: var(--color-bg);
      border-radius: var(--radius-md);
      padding: 28px;
      margin-bottom: 16px;
      text-align: center;
      border: 2px solid var(--color-border);
      min-height: 140px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .question-emoji {
      font-size: 2.5rem;
      margin-bottom: 12px;
      display: inline-block;
    }

    .board-main {
      font-size: 1.2rem;
      font-weight: 700;
      color: var(--color-text);
      margin-bottom: 6px;
      font-family: var(--font-display);
    }

    .board-sub {
      font-size: 0.9rem;
      color: var(--color-text-light);
      margin-bottom: 12px;
    }

    .skill-badge {
      display: inline-block;
      background: var(--color-primary);
      color: var(--color-surface);
      padding: 6px 14px;
      border-radius: var(--radius-md);
      font-size: 0.8rem;
      font-weight: 600;
    }

    .question-text {
      font-size: 1rem;
      font-weight: 600;
      color: var(--color-text);
      margin-bottom: 16px;
      text-align: center;
    }

    .answers-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 12px;
      margin-bottom: 16px;
    }

    .answers-grid.single-column {
      grid-template-columns: 1fr;
    }

    .answer-btn {
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-lg);
      padding: 20px 14px;
      font-size: 1.1rem;
      font-weight: 600;
      color: var(--color-text);
      cursor: pointer;
      transition: var(--transition);
      box-shadow: var(--shadow-sm);
      position: relative;
      text-align: center;
    }

    .answer-btn:hover:not(.correct):not(.incorrect) {
      background: var(--color-bg);
      border-color: var(--color-primary);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .answer-btn.correct {
      background: var(--color-success);
      border-color: var(--color-success);
      color: var(--color-surface);
    }

    .answer-btn.incorrect {
      background: var(--color-error);
      border-color: var(--color-error);
      color: var(--color-surface);
    }

    .answer-btn.correct::after {
      content: '‚úì';
      position: absolute;
      top: 8px;
      right: 12px;
      font-size: 1.2rem;
      font-weight: bold;
    }

    .answer-btn.incorrect::after {
      content: '‚úó';
      position: absolute;
      top: 8px;
      right: 12px;
      font-size: 1.2rem;
      font-weight: bold;
    }

    .explanation-box {
      background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
      border-left: 4px solid var(--color-accent);
      border-radius: var(--radius-md);
      padding: 16px;
      margin-bottom: 16px;
      font-size: 0.95rem;
      color: #78350f;
      line-height: 1.6;
      display: none;
    }

    .explanation-box.show {
      display: block;
    }

    .explanation-box strong {
      color: #92400e;
    }

    .feedback {
      background: var(--color-bg);
      border-left: 4px solid var(--color-primary);
      border-radius: var(--radius-md);
      padding: 16px 20px;
      margin-bottom: 16px;
      font-size: 1rem;
      font-weight: 600;
      color: var(--color-text);
      text-align: center;
      border: 1px solid var(--color-border);
    }

    .feedback.success {
      background: var(--color-success);
      border-left-color: var(--color-success);
      border-color: var(--color-success);
      color: #22543d;
    }

    .feedback.error {
      background: #fed7d7;
      border-left-color: var(--color-error);
      border-color: var(--color-error);
      color: #742a2a;
    }

    .action-buttons {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 12px;
    }

    .btn {
      padding: 16px 24px;
      border: 1px solid var(--color-border);
      border-radius: var(--radius-lg);
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: var(--transition);
      background: var(--color-primary);
      color: var(--color-surface);
      border-color: var(--color-primary-dark);
    }

    .btn:hover {
      background: var(--color-primary-dark);
      transform: translateY(-2px);
      box-shadow: var(--shadow-md);
    }

    .btn-secondary {
      background: var(--color-surface);
      color: var(--color-text);
      border-color: var(--color-border);
    }

    .btn-secondary:hover {
      background: var(--color-bg);
      border-color: var(--color-primary);
    }

    .achievement-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0);
      background: var(--color-surface);
      border-radius: var(--radius-lg);
      padding: 40px;
      box-shadow: 0 20px 60px rgba(61, 79, 66, 0.3);
      z-index: 1000;
      text-align: center;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      max-width: 90%;
      border: 2px solid var(--color-primary);
    }

    .achievement-popup.show {
      transform: translate(-50%, -50%) scale(1);
    }

    .achievement-popup .emoji {
      font-size: 4rem;
      margin-bottom: 16px;
    }

    .achievement-popup h2 {
      font-size: 1.5rem;
      margin: 0 0 12px 0;
      color: var(--color-primary-dark);
      font-family: var(--font-display);
    }

    .achievement-popup p {
      font-size: 1rem;
      color: var(--color-text);
      margin: 0;
    }

    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(61, 79, 66, 0.5);
      z-index: 999;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.3s ease;
      backdrop-filter: blur(4px);
    }

    .overlay.show {
      opacity: 1;
      pointer-events: all;
    }

    .confetti {
      position: fixed;
      width: 8px;
      height: 8px;
      position: absolute;
      animation: confetti-fall 3s linear forwards;
      z-index: 9999;
    }

    @keyframes confetti-fall {
      to {
        transform: translateY(100vh) rotate(720deg);
        opacity: 0;
      }
    }

    .sound-effect {
      position: fixed;
      font-size: 2rem;
      pointer-events: none;
      z-index: 9999;
      animation: soundPop 1s ease forwards;
    }

    @keyframes soundPop {
      0% {
        transform: scale(0);
        opacity: 1;
      }
      100% {
        transform: scale(2) translateY(-50px);
        opacity: 0;
      }
    }

    .mascot {
      position: fixed;
      bottom: 20px;
      right: 20px;
      font-size: 3rem;
      cursor: pointer;
      z-index: 100;
      filter: drop-shadow(0 2px 8px rgba(61, 79, 66, 0.2));
      transition: var(--transition);
      animation: float 3s ease-in-out infinite;
    }

    .mascot:hover {
      transform: scale(1.1);
    }

    @keyframes float {
      0%, 100% { transform: translateY(0px); }
      50% { transform: translateY(-15px); }
    }

    @media (max-width: 600px) {
      .header {
        padding: 12px;
      }

      .logo {
        font-size: 1.15rem;
      }

      .stat-box {
        font-size: 0.8rem;
        padding: 5px 10px;
      }

      .card {
        padding: 20px;
      }

      .question-card {
        padding: 20px;
      }

      .board-main {
        font-size: 1.1rem;
      }

      .answer-btn {
        padding: 16px 12px;
        font-size: 1rem;
      }

      .grade-emoji {
        font-size: 1.75rem;
      }

      .mascot {
        font-size: 2.5rem;
        bottom: 15px;
        right: 15px;
      }

      .achievement-popup {
        padding: 32px 24px;
      }

      .rank-value {
        font-size: 1.2rem;
      }
    }
  </style>
</head>
<body>

<div class="mascot" id="mascot" title="Klick mich!">ü¶â</div>

<div class="app-wrapper">
  <div class="header">
    <div class="logo">üéì Deutsch √ºben</div>
    <div class="stats">
      <div class="stat-box">
        üî• <span class="stat-value" id="statStreak">0</span>
      </div>
      <div class="stat-box">
        ‚≠ê <span class="stat-value" id="statLevel">1</span>
      </div>
      <div class="stat-box">
        üí∞ <span class="stat-value" id="statPoints">0</span>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- Badges -->
    <div class="badges-section" id="badgesSection">
      <div class="badge locked" data-badge="starter" title="Erste Aufgabe l√∂sen">
        <span class="badge-icon">üå±</span>
        <span class="badge-name">Starter</span>
      </div>
      <div class="badge locked" data-badge="streak5" title="5 in Folge richtig">
        <span class="badge-icon">üî•</span>
        <span class="badge-name">Feuer</span>
      </div>
      <div class="badge locked" data-badge="level5" title="Level 5 erreichen">
        <span class="badge-icon">‚≠ê</span>
        <span class="badge-name">Stern</span>
      </div>
      <div class="badge locked" data-badge="speed" title="Challenge schaffen">
        <span class="badge-icon">‚ö°</span>
        <span class="badge-name">Blitz</span>
      </div>
      <div class="badge locked" data-badge="master" title="100 Aufgaben l√∂sen">
        <span class="badge-icon">üèÜ</span>
        <span class="badge-name">Meister</span>
      </div>
      <div class="badge locked" data-badge="perfect" title="10 perfekte Runden">
        <span class="badge-icon">üíé</span>
        <span class="badge-name">Perfekt</span>
      </div>
    </div>

    <!-- Rank -->
    <div class="rank-section">
      <div class="rank-item">
        <span class="rank-icon">üèÖ</span>
        <div class="rank-label">Rang</div>
        <div class="rank-value" id="rankName">Anf√§nger</div>
      </div>
      <div class="rank-item">
        <span class="rank-icon">üìä</span>
        <div class="rank-label">Aufgaben</div>
        <div class="rank-value" id="totalTasks">0</div>
      </div>
    </div>

    <!-- Challenge -->
    <div class="challenge-mode" id="challengeMode">
      <div class="challenge-title">‚ö° CHALLENGE-MODUS ‚ö°</div>
      <div class="challenge-desc">10 Aufgaben in 2 Minuten!</div>
      <div class="timer" id="challengeTimer" style="display: none;">2:00</div>
    </div>

    <!-- Progress -->
    <div class="progress-section">
      <div class="progress-header">
        <span>Session-Fortschritt</span>
        <span id="progressText">0 / 10</span>
      </div>
      <div class="progress-bar">
        <div class="progress-fill" id="progressFill" style="width: 0%"></div>
      </div>
    </div>

    <!-- Controls Card -->
    <div class="card">
      <div class="section-title">W√§hle deine Klasse</div>
      <div class="grade-buttons" id="gradeRow">
        <button class="grade-btn active" data-g="1">
          <span class="grade-emoji">üìù</span>
          1. Klasse
        </button>
        <button class="grade-btn" data-g="2">
          <span class="grade-emoji">‚ùì</span>
          2. Klasse
        </button>
        <button class="grade-btn" data-g="3">
          <span class="grade-emoji">üìê</span>
          3. Klasse
        </button>
        <button class="grade-btn" data-g="4">
          <span class="grade-emoji">üìñ</span>
          4. Klasse
        </button>
      </div>

      <div class="section-title">Schwierigkeit</div>
      <div class="difficulty-selector">
        <button class="difficulty-btn active" data-diff="leicht">‚≠ê Leicht</button>
        <button class="difficulty-btn" data-diff="mittel">‚≠ê‚≠ê Mittel</button>
        <button class="difficulty-btn" data-diff="schwer">‚≠ê‚≠ê‚≠ê Schwer</button>
      </div>
    </div>

    <!-- Question Card -->
    <div class="question-card">
      <span class="question-emoji" id="questionEmoji">ü§î</span>
      <div class="board-main" id="boardMain">Tippe auf "Neue Aufgabe"</div>
      <div class="board-sub" id="boardSub">um loszulegen</div>
      <div class="skill-badge" id="skillBadge">Bereit!</div>
    </div>

    <div class="question-text" id="qText">W√§hle deine Klasse und starte!</div>

    <div class="answers-grid" id="answers"></div>

    <div class="explanation-box" id="explanationBox"></div>

    <div class="feedback" id="fb">W√§hle die passende Antwort.</div>

    <div class="action-buttons">
      <button class="btn" id="next">üöÄ Neue Aufgabe</button>
      <button class="btn btn-secondary" id="speakQ">üîä</button>
    </div>
  </div>
</div>

<div class="overlay" id="overlay"></div>
<div class="achievement-popup" id="achievementPopup">
  <div class="emoji" id="achievementEmoji">üèÜ</div>
  <h2 id="achievementTitle">Fantastisch!</h2>
  <p id="achievementText">Du hast ein Achievement freigeschaltet!</p>
</div>

<script>
// ===== DATEN =====
const GRADE_INFO = {
  1: { short: "Artikel & Plural", subtitle: "Artikel und Mehrzahl", emoji: "üìù" },
  2: { short: "Fragew√∂rter & F√§lle", subtitle: "W-Fragen und F√§lle", emoji: "‚ùì" },
  3: { short: "Alle F√§lle & Verben", subtitle: "4 F√§lle und Verben", emoji: "üìê" },
  4: { short: "Satzbau & Zeiten", subtitle: "S√§tze und Zeitformen", emoji: "üìñ" }
};

const NOUNS = [
  { word: "Hund", gender: "der", nom: "der Hund", gen: "des Hundes", dat: "dem Hund", akk: "den Hund", plural: "Hunde" },
  { word: "Katze", gender: "die", nom: "die Katze", gen: "der Katze", dat: "der Katze", akk: "die Katze", plural: "Katzen" },
  { word: "Kind", gender: "das", nom: "das Kind", gen: "des Kindes", dat: "dem Kind", akk: "das Kind", plural: "Kinder" },
  { word: "Baum", gender: "der", nom: "der Baum", gen: "des Baumes", dat: "dem Baum", akk: "den Baum", plural: "B√§ume" },
  { word: "Blume", gender: "die", nom: "die Blume", gen: "der Blume", dat: "der Blume", akk: "die Blume", plural: "Blumen" },
  { word: "Haus", gender: "das", nom: "das Haus", gen: "des Hauses", dat: "dem Haus", akk: "das Haus", plural: "H√§user" },
  { word: "Vogel", gender: "der", nom: "der Vogel", gen: "des Vogels", dat: "dem Vogel", akk: "den Vogel", plural: "V√∂gel" },
  { word: "Mutter", gender: "die", nom: "die Mutter", gen: "der Mutter", dat: "der Mutter", akk: "die Mutter", plural: "M√ºtter" },
  { word: "Auto", gender: "das", nom: "das Auto", gen: "des Autos", dat: "dem Auto", akk: "das Auto", plural: "Autos" },
  { word: "Ball", gender: "der", nom: "der Ball", gen: "des Balles", dat: "dem Ball", akk: "den Ball", plural: "B√§lle" },
  { word: "Puppe", gender: "die", nom: "die Puppe", gen: "der Puppe", dat: "der Puppe", akk: "die Puppe", plural: "Puppen" },
  { word: "Buch", gender: "das", nom: "das Buch", gen: "des Buches", dat: "dem Buch", akk: "das Buch", plural: "B√ºcher" },
  { word: "Lehrer", gender: "der", nom: "der Lehrer", gen: "des Lehrers", dat: "dem Lehrer", akk: "den Lehrer", plural: "Lehrer" },
  { word: "Schule", gender: "die", nom: "die Schule", gen: "der Schule", dat: "der Schule", akk: "die Schule", plural: "Schulen" },
  { word: "Fenster", gender: "das", nom: "das Fenster", gen: "des Fensters", dat: "dem Fenster", akk: "das Fenster", plural: "Fenster" },
  { word: "Tisch", gender: "der", nom: "der Tisch", gen: "des Tisches", dat: "dem Tisch", akk: "den Tisch", plural: "Tische" },
  { word: "Lampe", gender: "die", nom: "die Lampe", gen: "der Lampe", dat: "der Lampe", akk: "die Lampe", plural: "Lampen" },
  { word: "Apfel", gender: "der", nom: "der Apfel", gen: "des Apfels", dat: "dem Apfel", akk: "den Apfel", plural: "√Ñpfel" },
  { word: "Banane", gender: "die", nom: "die Banane", gen: "der Banane", dat: "der Banane", akk: "die Banane", plural: "Bananen" },
  { word: "Brot", gender: "das", nom: "das Brot", gen: "des Brotes", dat: "dem Brot", akk: "das Brot", plural: "Brote" }
];

const CASE_EXERCISES = [
  { sentence: "___ spielt im Garten.", correct: "Der Hund", case: "nominativ", question: "Wer?", options: ["Der Hund", "Den Hund", "Dem Hund"] },
  { sentence: "___ liegt auf dem Tisch.", correct: "Das Buch", case: "nominativ", question: "Was?", options: ["Das Buch", "Des Buches", "Dem Buch"] },
  { sentence: "___ ist sehr sch√∂n.", correct: "Die Blume", case: "nominativ", question: "Was?", options: ["Die Blume", "Der Blume", "Die Blumen"] },
  { sentence: "Ich sehe ___.", correct: "den Vogel", case: "akkusativ", question: "Wen?", options: ["den Vogel", "der Vogel", "dem Vogel"] },
  { sentence: "Sie kauft ___.", correct: "das Auto", case: "akkusativ", question: "Was?", options: ["das Auto", "des Autos", "dem Auto"] },
  { sentence: "Wir besuchen ___.", correct: "die Oma", case: "akkusativ", question: "Wen?", options: ["die Oma", "der Oma", "den Oma"] },
  { sentence: "Er liest ___.", correct: "das Buch", case: "akkusativ", question: "Was?", options: ["das Buch", "des Buches", "dem Buch"] },
  { sentence: "Ich gebe ___ das Spielzeug.", correct: "dem Kind", case: "dativ", question: "Wem?", options: ["dem Kind", "das Kind", "den Kind"] },
  { sentence: "Sie hilft ___ bei den Hausaufgaben.", correct: "der Schwester", case: "dativ", question: "Wem?", options: ["der Schwester", "die Schwester", "den Schwester"] },
  { sentence: "Wir danken ___.", correct: "dem Lehrer", case: "dativ", question: "Wem?", options: ["dem Lehrer", "der Lehrer", "den Lehrer"] },
  { sentence: "Das ist das Haus ___.", correct: "des Nachbarn", case: "genitiv", question: "Wessen?", options: ["des Nachbarn", "dem Nachbarn", "der Nachbar"] },
  { sentence: "Die Farbe ___ ist rot.", correct: "des Autos", case: "genitiv", question: "Wessen?", options: ["des Autos", "dem Auto", "das Auto"] }
];

const PREPOSITION_EXERCISES = [
  { sentence: "Ich gehe ___ den Park.", correct: "durch", options: ["durch", "bei", "mit", "von"] },
  { sentence: "Das Geschenk ist ___ dich.", correct: "f√ºr", options: ["f√ºr", "zu", "mit", "bei"] },
  { sentence: "Wir fahren ___ die Stadt.", correct: "um", options: ["um", "bei", "zu", "von"] },
  { sentence: "Er kommt ___ der Schule.", correct: "aus", options: ["aus", "durch", "f√ºr", "um"] },
  { sentence: "Sie wohnt ___ ihrer Oma.", correct: "bei", options: ["bei", "f√ºr", "durch", "ohne"] },
  { sentence: "Ich fahre ___ dem Zug.", correct: "mit", options: ["mit", "f√ºr", "um", "durch"] }
];

const VERB_EXERCISES = [
  { infinitiv: "gehen", person: "ich", correct: "gehe", options: ["gehe", "gehst", "geht", "gehen"] },
  { infinitiv: "gehen", person: "du", correct: "gehst", options: ["gehe", "gehst", "geht", "gehen"] },
  { infinitiv: "gehen", person: "er/sie/es", correct: "geht", options: ["gehe", "gehst", "geht", "gehen"] },
  { infinitiv: "spielen", person: "ich", correct: "spiele", options: ["spiele", "spielst", "spielt", "spielen"] },
  { infinitiv: "spielen", person: "du", correct: "spielst", options: ["spiele", "spielst", "spielt", "spielen"] },
  { infinitiv: "spielen", person: "wir", correct: "spielen", options: ["spiele", "spielst", "spielt", "spielen"] },
  { infinitiv: "lesen", person: "ich", correct: "lese", options: ["lese", "liest", "lest", "lesen"] },
  { infinitiv: "lesen", person: "du", correct: "liest", options: ["lese", "liest", "lest", "lesen"] },
  { infinitiv: "lesen", person: "er/sie/es", correct: "liest", options: ["lese", "liest", "lest", "lesen"] },
  { infinitiv: "haben", person: "ich", correct: "habe", options: ["habe", "hast", "hat", "haben"] },
  { infinitiv: "haben", person: "du", correct: "hast", options: ["habe", "hast", "hat", "haben"] },
  { infinitiv: "sein", person: "ich", correct: "bin", options: ["bin", "bist", "ist", "sind"] },
  { infinitiv: "sein", person: "du", correct: "bist", options: ["bin", "bist", "ist", "sind"] }
];

const TENSE_EXERCISES = [
  { present: "Ich gehe zur Schule.", past: "Ich ging zur Schule." },
  { present: "Er spielt Fu√üball.", past: "Er spielte Fu√üball." },
  { present: "Sie liest ein Buch.", past: "Sie las ein Buch." },
  { present: "Wir haben Spa√ü.", past: "Wir hatten Spa√ü." }
];

const W_QUESTIONS = [
  { word: "Wer", emoji: "üë§", sentence: "___ kommt heute zu Besuch?", wrongSpell: ["Wehr", "W√§r"], hint: "nach Personen" },
  { word: "Was", emoji: "üì¶", sentence: "___ ist in der Kiste?", wrongSpell: ["Wass", "Vas"], hint: "nach Dingen" },
  { word: "Wo", emoji: "üìç", sentence: "___ ist mein Spielzeug?", wrongSpell: ["Woh", "Voh"], hint: "nach Ort" },
  { word: "Wann", emoji: "‚è∞", sentence: "___ gehen wir nach Hause?", wrongSpell: ["Wan", "Vann"], hint: "nach Zeit" },
  { word: "Wie", emoji: "‚ùì", sentence: "___ hei√üt du?", wrongSpell: ["Wieh", "Vii"], hint: "nach Art" },
  { word: "Warum", emoji: "ü§î", sentence: "___ ist der Himmel blau?", wrongSpell: ["Warumm", "Varumm"], hint: "nach Grund" },
  { word: "Wem", emoji: "üéÅ", sentence: "___ gibst du das Geschenk?", wrongSpell: ["Wehm", "Vem"], hint: "Dativ" },
  { word: "Wen", emoji: "üëÄ", sentence: "___ siehst du dort?", wrongSpell: ["Wenn", "Ven"], hint: "Akkusativ" },
  { word: "Wessen", emoji: "üëã", sentence: "___ Buch ist das?", wrongSpell: ["Wesen", "Vessen"], hint: "Genitiv" }
];

const SENTENCES_GOOD = [
  "Ich gehe heute in den Park.",
  "Der Hund spielt mit dem Ball.",
  "Mama kocht leckeres Essen.",
  "Wir fahren morgen ans Meer.",
  "Das Buch liegt auf dem Tisch.",
  "Meine Schwester liest ein Buch.",
  "Der Lehrer erkl√§rt die Aufgabe.",
  "Am Wochenende besuchen wir Oma.",
  "Die Katze schl√§ft in ihrem Korb.",
  "Papa repariert das Fahrrad.",
  "Im Winter bauen wir einen Schneemann.",
  "Die V√∂gel singen am Morgen.",
  "Ich male ein buntes Bild.",
  "Der Zug f√§hrt um acht Uhr ab."
];

const SENTENCES_BAD = [
  "Ich heute gehe Park in den.",
  "Der mit Ball spielt Hund dem.",
  "Mama leckeres Essen kocht.",
  "Wir morgen Meer ans fahren.",
  "Das liegt Buch Tisch auf dem.",
  "Meine liest Schwester Buch ein.",
  "Der erkl√§rt Lehrer Aufgabe die.",
  "Am besuchen Wochenende Oma wir.",
  "Die in schl√§ft Katze Korb ihrem.",
  "Papa das repariert Fahrrad.",
  "Im bauen Winter Schneemann wir einen.",
  "Die am singen V√∂gel Morgen.",
  "Ich buntes male Bild ein.",
  "Der um f√§hrt Zug ab acht Uhr."
];

const PRAISE_TEXTS = [
  "Super! üåü",
  "Perfekt! üéâ",
  "Genial! üí™",
  "Toll! ‚ú®",
  "Klasse! üèÜ",
  "Prima! ‚≠ê",
  "Spitze! üéØ",
  "Bravo! üëè"
];

const RETRY_TEXTS = [
  "Versuch's nochmal! ü§î",
  "Fast! üëÄ",
  "Weiter so! üí´",
  "Du schaffst das! üìñ"
];

const EXPLANATIONS = {
  1: {
    def: "Der Artikel zeigt das Geschlecht: <strong>der</strong> (m√§nnlich), <strong>die</strong> (weiblich), <strong>das</strong> (s√§chlich).",
    indef: "Bei 'ein/eine' gilt: <strong>der/das ‚Üí ein</strong>, <strong>die ‚Üí eine</strong>.",
    plural: "Die Mehrzahl: oft -e, -en, -er oder -s. Manchmal Umlaut: a‚Üí√§."
  },
  2: {
    wfragen: "Fragew√∂rter: <strong>Wer</strong>, <strong>Was</strong>, <strong>Wo</strong>, <strong>Wann</strong>, <strong>Wie</strong>, <strong>Warum</strong>.",
    cases_intro: "Die vier F√§lle: <strong>Nominativ</strong> (Wer?), <strong>Akkusativ</strong> (Wen?), <strong>Dativ</strong> (Wem?), <strong>Genitiv</strong> (Wessen?)."
  },
  3: {
    nominativ: "<strong>Nominativ</strong> (Wer/Was?). Das Subjekt.",
    akkusativ: "<strong>Akkusativ</strong> (Wen/Was?). Das direkte Objekt.",
    dativ: "<strong>Dativ</strong> (Wem?). Das indirekte Objekt.",
    genitiv: "<strong>Genitiv</strong> (Wessen?). Zeigt Besitz.",
    verben: "Verben √§ndern sich: ich <strong>gehe</strong>, du <strong>gehst</strong>, er <strong>geht</strong>.",
    pr√§positionen: "Pr√§positionen: <strong>Akkusativ:</strong> durch, f√ºr, um. <strong>Dativ:</strong> aus, bei, mit, von, zu."
  },
  4: {
    satzbau: "Verb an <strong>zweiter Stelle</strong>!",
    zeiten: "<strong>Pr√§sens</strong> (jetzt), <strong>Pr√§teritum</strong> (ich ging), <strong>Perfekt</strong> (ich bin gegangen)."
  }
};

const RANKS = [
  { minPoints: 0, name: "Anf√§nger", emoji: "üå±" },
  { minPoints: 100, name: "Lehrling", emoji: "üìö" },
  { minPoints: 300, name: "Sch√ºler", emoji: "‚úèÔ∏è" },
  { minPoints: 600, name: "Experte", emoji: "üéì" },
  { minPoints: 1000, name: "Meister", emoji: "üëë" },
  { minPoints: 2000, name: "Champion", emoji: "üèÜ" },
  { minPoints: 5000, name: "Legende", emoji: "‚≠ê" }
];

// Helper
function pick(arr) {
  if (!Array.isArray(arr) || arr.length === 0) return null;
  return arr[Math.floor(Math.random() * arr.length)];
}

function indefArticle(gender) {
  return gender === "die" ? "eine" : "ein";
}

function otherWWords(correct) {
  const pool = W_QUESTIONS.map(x => x.word).filter(w => w !== correct);
  for (let i = pool.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [pool[i], pool[j]] = [pool[j], pool[i]];
  }
  return pool.slice(0, 2);
}

// Task builder
let currentDifficulty = 'leicht';
let currentGrade = 1;

function buildTask(grade) {
  let q = "", options = [], correctIndex = 0, boardMain = "", boardSub = "", signature = "", taskMode = "", skillName = "";

  if (grade === 1) {
    const taskType = Math.random();
    if (taskType < 0.5) {
      const noun = pick(NOUNS);
      taskMode = "def";
      skillName = "Artikel";
      q = "Welcher Artikel passt zu " + noun.word + "?";
      options = ["der", "die", "das"];
      correctIndex = options.indexOf(noun.gender);
      boardMain = "___ " + noun.word;
      boardSub = "der ¬∑ die ¬∑ das";
      signature = "1:def:" + noun.word;
    } else {
      const noun = pick(NOUNS);
      taskMode = "plural";
      skillName = "Mehrzahl";
      q = "Wie hei√üt die Mehrzahl von " + noun.word + "?";
      const wrong1 = noun.word + "e";
      const wrong2 = noun.word + "en";
      options = [noun.plural, wrong1, wrong2].filter((v, i, arr) => arr.indexOf(v) === i).slice(0, 3);
      for (let i = options.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [options[i], options[j]] = [options[j], options[i]];
      }
      correctIndex = options.indexOf(noun.plural);
      boardMain = "ein " + noun.word + " ‚Üí viele ___";
      boardSub = "Mehrzahl";
      signature = "1:plural:" + noun.word;
    }
  }
  else if (grade === 2) {
    const taskType = Math.random();
    if (taskType < 0.6) {
      const item = pick(W_QUESTIONS);
      taskMode = "wfragen";
      skillName = "Fragew√∂rter";
      const sentenceWithEmoji = item.sentence.replace("___", item.emoji);
      q = "Welches Fragewort passt?";
      const correctWord = item.word;
      const others = otherWWords(correctWord);
      options = [correctWord, ...others];
      for (let i = options.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [options[i], options[j]] = [options[j], options[i]];
      }
      correctIndex = options.indexOf(correctWord);
      boardMain = sentenceWithEmoji;
      boardSub = item.hint;
      signature = "2:wfrage:" + item.word;
    } else {
      const caseEx = pick(CASE_EXERCISES.filter(ex => ex.case === "nominativ" || ex.case === "akkusativ"));
      taskMode = "cases_intro";
      skillName = caseEx.case === "nominativ" ? "Nominativ" : "Akkusativ";
      q = "Welches Wort passt?";
      options = caseEx.options;
      correctIndex = options.indexOf(caseEx.correct);
      boardMain = caseEx.sentence;
      boardSub = caseEx.question;
      signature = "2:case:" + caseEx.sentence;
    }
  }
  else if (grade === 3) {
    const taskType = Math.random();
    if (taskType < 0.5) {
      const caseEx = pick(CASE_EXERCISES);
      taskMode = caseEx.case;
      skillName = { nominativ: "Nominativ", genitiv: "Genitiv", dativ: "Dativ", akkusativ: "Akkusativ" }[caseEx.case];
      q = "Welches Wort passt? (" + caseEx.question + ")";
      options = caseEx.options;
      correctIndex = options.indexOf(caseEx.correct);
      boardMain = caseEx.sentence;
      boardSub = skillName;
      signature = "3:case:" + caseEx.case;
    } else if (taskType < 0.75) {
      const prepEx = pick(PREPOSITION_EXERCISES);
      taskMode = "pr√§positionen";
      skillName = "Pr√§positionen";
      q = "Welche Pr√§position passt?";
      options = prepEx.options;
      correctIndex = options.indexOf(prepEx.correct);
      boardMain = prepEx.sentence;
      boardSub = "Pr√§positionen";
      signature = "3:prep:" + prepEx.sentence;
    } else {
      const verbEx = pick(VERB_EXERCISES);
      taskMode = "verben";
      skillName = "Verben";
      q = "Richtige Form von '" + verbEx.infinitiv + "' f√ºr " + verbEx.person + "?";
      options = verbEx.options;
      correctIndex = options.indexOf(verbEx.correct);
      boardMain = verbEx.person + " " + verbEx.infinitiv + " ‚Üí ___";
      boardSub = "Konjugieren";
      signature = "3:verb:" + verbEx.infinitiv;
    }
  }
  else {
    const taskType = Math.random();
    if (taskType < 0.4) {
      taskMode = "satzbau";
      skillName = "Satzbau";
      q = "Welcher Satz ist richtig?";
      const good = pick(SENTENCES_GOOD);
      const bad = pick(SENTENCES_BAD);
      if (Math.random() < 0.5) {
        options = [good, bad];
        correctIndex = 0;
      } else {
        options = [bad, good];
        correctIndex = 1;
      }
      boardMain = "Richtiger Satz?";
      boardSub = "Satzbau";
      signature = "4:satz:" + options[0];
    } else if (taskType < 0.7) {
      const tenseEx = pick(TENSE_EXERCISES);
      taskMode = "zeiten";
      skillName = "Zeitformen";
      q = "Wie hei√üt der Satz in der Vergangenheit?";
      const wrong1 = tenseEx.present;
      const wrong2 = tenseEx.present.replace(/\./g, ' gestern.');
      options = [tenseEx.past, wrong1, wrong2].filter((v, i, arr) => arr.indexOf(v) === i);
      for (let i = options.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [options[i], options[j]] = [options[j], options[i]];
      }
      correctIndex = options.indexOf(tenseEx.past);
      boardMain = "Gegenwart: " + tenseEx.present;
      boardSub = "Vergangenheit?";
      signature = "4:zeit:" + tenseEx.present;
    } else {
      const caseEx = pick(CASE_EXERCISES);
      taskMode = caseEx.case;
      skillName = "Die vier F√§lle";
      q = "Welches Wort passt? (" + caseEx.question + ")";
      options = caseEx.options;
      correctIndex = options.indexOf(caseEx.correct);
      boardMain = caseEx.sentence;
      boardSub = skillName;
      signature = "4:case:" + caseEx.sentence;
    }
  }

  return { q, options, correctIndex, boardMain, boardSub, signature, taskMode, skillName };
}

function isTaskPlausible(task) {
  if (!task) return false;
  if (typeof task.q !== "string" || !task.q.trim()) return false;
  if (!Array.isArray(task.options) || task.options.length < 2) return false;
  if (typeof task.correctIndex !== "number") return false;
  if (task.correctIndex < 0 || task.correctIndex >= task.options.length) return false;
  return true;
}

// UI
const gradeRow = document.getElementById("gradeRow");
const qText = document.getElementById("qText");
const answersBox = document.getElementById("answers");
const fb = document.getElementById("fb");
const nextBtn = document.getElementById("next");
const speakQBtn = document.getElementById("speakQ");
const boardMainEl = document.getElementById("boardMain");
const boardSubEl = document.getElementById("boardSub");
const questionEmojiEl = document.getElementById("questionEmoji");
const skillBadge = document.getElementById("skillBadge");
const progressFill = document.getElementById("progressFill");
const progressText = document.getElementById("progressText");
const explanationBox = document.getElementById("explanationBox");
const achievementPopup = document.getElementById("achievementPopup");
const overlay = document.getElementById("overlay");
const statPoints = document.getElementById("statPoints");
const statLevel = document.getElementById("statLevel");
const statStreak = document.getElementById("statStreak");
const rankName = document.getElementById("rankName");
const totalTasksEl = document.getElementById("totalTasks");
const challengeMode = document.getElementById("challengeMode");
const challengeTimer = document.getElementById("challengeTimer");
const mascot = document.getElementById("mascot");

let totalTasks = 0;
let currentStreak = 0;
let sessionGoal = 10;
let sessionProgress = 0;
let userLevel = 1;
let points = 0;
let currentTask = null;
let lastTaskSignatureByGrade = {};
let isChallengeMode = false;
let challengeTimeLeft = 120;
let challengeInterval = null;
let challengeStartTime = null;
let unlockedBadges = new Set();

function loadProgress() {
  const saved = localStorage.getItem('deutschProgress');
  if (saved) {
    const data = JSON.parse(saved);
    totalTasks = data.totalTasks || 0;
    currentStreak = data.currentStreak || 0;
    userLevel = data.userLevel || 1;
    points = data.points || 0;
    unlockedBadges = new Set(data.unlockedBadges || []);
  }
  updateBadges();
}

function saveProgress() {
  localStorage.setItem('deutschProgress', JSON.stringify({
    totalTasks,
    currentStreak,
    userLevel,
    points,
    unlockedBadges: Array.from(unlockedBadges)
  }));
}

function updateStats() {
  userLevel = Math.floor(totalTasks / 20) + 1;
  if (statLevel) statLevel.textContent = userLevel;
  if (statPoints) statPoints.textContent = points;
  if (statStreak) statStreak.textContent = currentStreak;
  if (totalTasksEl) totalTasksEl.textContent = totalTasks;
  
  const currentRank = RANKS.slice().reverse().find(r => points >= r.minPoints);
  if (rankName && currentRank) rankName.textContent = currentRank.emoji + " " + currentRank.name;
  
  const progress = Math.min((sessionProgress / sessionGoal) * 100, 100);
  progressFill.style.width = progress + "%";
  progressText.textContent = sessionProgress + " / " + sessionGoal;
  
  saveProgress();
}

function addPoints(amount) {
  points += amount;
  showFloatingPoints(amount);
  updateStats();
}

function showFloatingPoints(amount) {
  const el = document.createElement('div');
  el.className = 'sound-effect';
  el.textContent = '+' + amount + ' üí∞';
  el.style.left = Math.random() * window.innerWidth + 'px';
  el.style.top = Math.random() * window.innerHeight / 2 + 'px';
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 1000);
}

function unlockBadge(badgeName) {
  if (unlockedBadges.has(badgeName)) return;
  unlockedBadges.add(badgeName);
  const badge = document.querySelector(`[data-badge="${badgeName}"]`);
  if (badge) {
    badge.classList.remove('locked');
    badge.classList.add('unlocked');
  }
  saveProgress();
  showAchievementPopup(badgeName);
}

function checkBadges() {
  if (totalTasks >= 1) unlockBadge('starter');
  if (currentStreak >= 5) unlockBadge('streak5');
  if (userLevel >= 5) unlockBadge('level5');
  if (totalTasks >= 100) unlockBadge('master');
}

function updateBadges() {
  unlockedBadges.forEach(badgeName => {
    const badge = document.querySelector(`[data-badge="${badgeName}"]`);
    if (badge) {
      badge.classList.remove('locked');
      badge.classList.add('unlocked');
    }
  });
}

function showAchievementPopup(badgeName) {
  const badges = {
    starter: { emoji: 'üå±', title: 'Starter!', text: 'Erste Aufgabe gel√∂st!' },
    streak5: { emoji: 'üî•', title: 'Feuer!', text: '5 in Folge richtig!' },
    level5: { emoji: '‚≠ê', title: 'Stern!', text: 'Level 5 erreicht!' },
    speed: { emoji: '‚ö°', title: 'Blitz!', text: 'Challenge geschafft!' },
    master: { emoji: 'üèÜ', title: 'Meister!', text: '100 Aufgaben gel√∂st!' },
    perfect: { emoji: 'üíé', title: 'Perfekt!', text: '10 perfekte Runden!' }
  };
  
  const badge = badges[badgeName];
  if (!badge) return;
  
  document.getElementById('achievementEmoji').textContent = badge.emoji;
  document.getElementById('achievementTitle').textContent = badge.title;
  document.getElementById('achievementText').textContent = badge.text;
  
  overlay.classList.add('show');
  achievementPopup.classList.add('show');
  createConfetti();
  
  setTimeout(() => {
    overlay.classList.remove('show');
    achievementPopup.classList.remove('show');
  }, 3000);
}

function createConfetti() {
  const colors = ['#7BA591', '#E8B86D', '#88B894', '#D4816F', '#A8C9B8'];
  for (let i = 0; i < 30; i++) {
    const confetti = document.createElement('div');
    confetti.className = 'confetti';
    confetti.style.left = Math.random() * 100 + '%';
    confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
    confetti.style.animationDelay = Math.random() * 0.5 + 's';
    document.body.appendChild(confetti);
    setTimeout(() => confetti.remove(), 3000);
  }
}

function startChallenge() {
  isChallengeMode = true;
  challengeTimeLeft = 120;
  challengeStartTime = Date.now();
  sessionGoal = 10;
  sessionProgress = 0;
  challengeMode.classList.add('active');
  challengeTimer.style.display = 'block';
  updateChallengeTimer();
  challengeInterval = setInterval(updateChallengeTimer, 1000);
}

function updateChallengeTimer() {
  const elapsed = Math.floor((Date.now() - challengeStartTime) / 1000);
  challengeTimeLeft = 120 - elapsed;
  
  if (challengeTimeLeft <= 0) {
    endChallenge(false);
    return;
  }
  
  const mins = Math.floor(challengeTimeLeft / 60);
  const secs = challengeTimeLeft % 60;
  challengeTimer.textContent = mins + ':' + (secs < 10 ? '0' : '') + secs;
}

function endChallenge(success) {
  isChallengeMode = false;
  challengeMode.classList.remove('active');
  challengeTimer.style.display = 'none';
  if (challengeInterval) {
    clearInterval(challengeInterval);
    challengeInterval = null;
  }
  
  if (success) {
    unlockBadge('speed');
    addPoints(200);
    fb.className = "feedback success";
    fb.textContent = "Challenge geschafft! +200 Bonus!";
  } else {
    fb.className = "feedback error";
    fb.textContent = "Zeit abgelaufen!";
  }
}

challengeMode.onclick = () => {
  if (!isChallengeMode) {
    startChallenge();
    renderTask();
  }
};

mascot.onclick = () => {
  const messages = [
    "Super! ü¶â",
    "Weiter so! üåü",
    "Du schaffst das! üí™",
    "Toll! üèÜ"
  ];
  fb.className = "feedback";
  fb.textContent = pick(messages);
};

let kidVoice = null;
function pickKidVoice() {
  if (!("speechSynthesis" in window)) return;
  const voices = speechSynthesis.getVoices();
  if (!voices || !voices.length) return;
  const deVoices = voices.filter(v => v.lang && v.lang.toLowerCase().startsWith("de"));
  if (deVoices.length) {
    const friendly = deVoices.find(v => /kinder|child|lena|anna|marlene|lea|mia|sophie/i.test(v.name));
    kidVoice = friendly || deVoices[0];
  } else {
    kidVoice = voices[0];
  }
}
if ("speechSynthesis" in window) {
  speechSynthesis.onvoiceschanged = pickKidVoice;
  pickKidVoice();
}

function applyGradeInfo() {
  const info = GRADE_INFO[currentGrade];
  if (!info) return;
  if (questionEmojiEl) questionEmojiEl.textContent = info.emoji;
}

gradeRow.onclick = (e) => {
  const btn = e.target.closest("button[data-g]");
  if (!btn) return;
  currentGrade = Number(btn.dataset.g) || 1;
  gradeRow.querySelectorAll("button").forEach(b => b.classList.remove("active"));
  btn.classList.add("active");
  applyGradeInfo();
  fb.className = "feedback";
  explanationBox.classList.remove('show');
};

document.querySelectorAll('.difficulty-btn').forEach(btn => {
  btn.onclick = () => {
    currentDifficulty = btn.dataset.diff;
    document.querySelectorAll('.difficulty-btn').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
  };
});

function speak(text) {
  if (!("speechSynthesis" in window)) return;
  const u = new SpeechSynthesisUtterance(text);
  u.lang = "de-DE";
  if (kidVoice) u.voice = kidVoice;
  u.rate = 0.82;
  u.pitch = 0.98;
  u.volume = 0.9;
  speechSynthesis.cancel();
  speechSynthesis.speak(u);
}

speakQBtn.onclick = () => {
  if (currentTask && currentTask.q) {
    speak(currentTask.q);
  }
};

function showExplanation(isCorrect) {
  if (isCorrect) {
    explanationBox.classList.remove('show');
    return;
  }
  
  let explanation = "";
  if (currentGrade === 1) {
    explanation = EXPLANATIONS[1][currentTask.taskMode || 'def'];
  } else if (currentGrade === 2) {
    explanation = EXPLANATIONS[2][currentTask.taskMode || 'wfragen'];
  } else if (currentGrade === 3) {
    explanation = EXPLANATIONS[3][currentTask.taskMode || 'nominativ'];
  } else {
    explanation = EXPLANATIONS[4][currentTask.taskMode || 'satzbau'];
  }
  
  explanationBox.innerHTML = "<strong>üí° Tipp:</strong> " + (explanation || "Versuch es nochmal!");
  explanationBox.classList.add('show');
}

function renderTask() {
  let safety = 0;
  let task;
  do {
    task = buildTask(currentGrade);
    safety++;
    if (safety > 20) break;
  } while (!isTaskPlausible(task) || (task.signature && task.signature === lastTaskSignatureByGrade[currentGrade]));

  currentTask = task;
  totalTasks++;
  sessionProgress++;
  updateStats();
  checkBadges();
  lastTaskSignatureByGrade[currentGrade] = currentTask.signature || "";

  if (isChallengeMode && sessionProgress >= sessionGoal) {
    endChallenge(true);
    return;
  }

  qText.textContent = currentTask.q;
  answersBox.innerHTML = "";
  fb.className = "feedback";
  fb.textContent = "W√§hle die passende Antwort.";
  explanationBox.classList.remove('show');

  if (boardMainEl) boardMainEl.textContent = currentTask.boardMain || "";
  if (boardSubEl) boardSubEl.textContent = currentTask.boardSub || "";
  if (skillBadge) skillBadge.textContent = currentTask.skillName || "√úbung";

  if (currentGrade === 4 && currentTask.options[0].length > 30) {
    answersBox.className = "answers-grid single-column";
  } else {
    answersBox.className = "answers-grid";
  }

  let lastTap = 0;

  currentTask.options.forEach((val, i) => {
    const B = document.createElement("button");
    B.className = "answer-btn";
    B.textContent = val;
    B.onclick = () => {
      const now = Date.now();
      if (now - lastTap > 350) {
        speak(val);
        fb.className = "feedback";
        fb.textContent = "Doppelt tippen zum Ausw√§hlen.";
      } else {
        answersBox.querySelectorAll("button").forEach(x => x.classList.remove("correct", "incorrect"));
        if (i === currentTask.correctIndex) {
          B.classList.add("correct");
          currentStreak++;
          
          let pointsEarned = 10;
          if (currentDifficulty === 'mittel') pointsEarned = 15;
          if (currentDifficulty === 'schwer') pointsEarned = 25;
          if (currentStreak >= 5) pointsEarned *= 2;
          
          addPoints(pointsEarned);
          updateStats();
          checkBadges();
          
          fb.className = "feedback success";
          const praise = pick(PRAISE_TEXTS) || "Toll!";
          fb.textContent = praise + " +" + pointsEarned + " Punkte!";
          showExplanation(true);
          
          if (currentStreak === 5 || currentStreak === 10 || currentStreak === 20) {
            createConfetti();
          }
        } else {
          B.classList.add("incorrect");
          currentStreak = 0;
          updateStats();
          fb.className = "feedback error";
          const retry = pick(RETRY_TEXTS) || "Versuch's nochmal!";
          fb.textContent = retry;
          showExplanation(false);
        }
      }
      lastTap = now;
    };
    answersBox.appendChild(B);
  });
}

loadProgress();
applyGradeInfo();
updateStats();
nextBtn.onclick = renderTask;
</script>
</body>
</html>
